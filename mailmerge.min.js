function mailmerge(){form=rcmail.gui_objects.messageform,formData=new FormData,formData.append("_mode",rcmail.editor.is_html()?"html":"txt"),formData.append("message",rcmail.editor.get_content()),formData.append("_subject",$("[name='_subject']",form).val().trim()),formData.append("_from",$("[name='_from']",form).val()),formData.append("_to",$("[name='_to']",form).val()),input_cc=$("[name='_cc']",form).val().trim().split(",").map(a=>a.trim()),formData.append("_cc",input_cc),input_bcc=$("[name='_bcc']",form).val().trim().split(",").map(a=>a.trim()),formData.append("_bcc",input_bcc),input_replyto=$("[name='_replyto']",form).val().trim().split(",").map(a=>a.trim()),formData.append("_replyto",input_replyto),input_followupto=$("[name='_followupto']",form).val().trim().split(",").map(a=>a.trim()),formData.append("_followupto",input_followupto),formData.append("_separator",$("#mailmergesep").val()),formData.append("_enclosure",$("#mailmergeencl").val()),formData.append("_folder",$("#mailmergefolder").val()),formData.append("_encoding",$("#mailmergefenc").val()),formData.append("_behavior",$("#mailmergebehav").val());let a=document.querySelector("#mailmergefile").files;if(0!==a.length)formData.append("csv",a[0],"data.csv");else return void rcmail.show_popup_dialog("No CSV File was selected!","Error");formData.append("_compose_id",rcmail.env.compose_id),formData.append("_mdn",document.querySelector("[name=_mdn]").checked),formData.append("_dsn",document.querySelector("[name=_dsn]").checked),formData.append("_priority",document.querySelector("[name=_priority]").value),formData.append("_reply_msgid",rcmail.env.reply_msgid);const b=rcmail.set_busy(!0,"loading");formData.append("_unlock",b),formData.append("_remote",1),$.ajax({type:"POST",url:rcmail.url("plugin.mailmerge"),data:formData,dataType:"json",contentType:!1,processData:!1,success:function(a){rcmail.http_response(a)},error:function(a,b,c){rcmail.http_error(a,b,c,!1,"plugin.mailmerge")}})}rcmail.addEventListener("init",function(a){console.log(a),rcmail.env.compose_commands?(rcmail.register_command("plugin.mailmerge",mailmerge,!0),rcmail.env.compose_commands.push("plugin.mailmerge"),rcmail.http_get("plugin.mailmerge.get-folders")):(document.querySelector("#mailmerge_sendunsent").addEventListener("click",function(){console.log(rcmail.env.mailmerge_currentfolder),rcmail.http_post("plugin.mailmerge.send-unsent",{_mbox:rcmail.env.mailmerge_currentmbox,_search:rcmail.env.search_request},rcmail.set_busy(!0,"loading"))}),rcmail.env.mailmerge_currentmbox=rcmail.env.mailbox,rcmail.triggerEvent("mailmerge_buttonstate"))}),rcmail.addEventListener("plugin.mailmerge.folders",function(a){const b=a.special_folders.drafts??"Drafts";$.each(a.folders,function(a,c){$("#mailmergefolder").append($("<option>",{value:c,text:c,selected:c===b}))})}),rcmail.addEventListener("beforesavedraft",function(...a){console.log(a)}),rcmail.addEventListener("aftersavedraft",function(...a){console.log(a)}),rcmail.addEventListener("listupdate",function(a){console.log("listupdate",a),rcmail.env.mailmerge_currentmbox=a.folder,rcmail.triggerEvent("mailmerge_buttonstate")}),rcmail.addEventListener("mailmerge_buttonstate",function(){const a=rcmail.env.mailmerge_currentmbox.split(rcmail.env.delimiter);console.log(a,rcmail.env.drafts_mailbox,rcmail.env.search_request,rcmail.env.search_scope),document.querySelector("#mailmerge_sendunsent").classList.add("hidden","disabled"),a.forEach((b,c)=>{const d=a.slice(0,c+1).join(rcmail.env.delimiter);d===rcmail.env.drafts_mailbox&&(document.querySelector("#mailmerge_sendunsent").classList.remove("hidden"),(null===rcmail.env.search_request||rcmail.env.search_request===void 0||"base"===rcmail.env.search_scope)&&document.querySelector("#mailmerge_sendunsent").classList.remove("disabled"))})});